Title: agentic-convo-workflow
Date: 2025-04-27
Category: blog
Tags: thoughts
Slug: agentic-convo-workflow
Authors: james gadoury 

I got really excited last year as agentic workflows were becoming more popular.... and I did nothing about it :) 

After watching [Andrew Ng's talk on this subject](https://www.youtube.com/watch?v=KrRD7r7y7NY) recently, I decided to dedicate time every week to learn more about how to build agentic workflows.

My first toy project is this simple workflow using langgraph to start a convo between two personas: a patient "John" and a therapist "Sarah".

I also played around with prompting an agent to decide when to end the workflow (so that it didn't just run forever).

It worked surprisingly well on my first try and required almost no effort from me to setup.
See this example of a few iterations of the loop (note that the [] below indicate different nodes in the langchain):

```
----------------------------
[john_starts]:
(nervously taking a seat) Ah, hi Sarah. I'm...I'm not sure where to start, to be honest. (pausing for a moment) I've been feeling really overwhelmed lately. Just like everything is piling up on me and I don't know how to manage it all. Work's been stressing me out, my relationship with my family's been strained...just feeling like I'm stuck in this rut and can't get out of it. (sighing) And the worst part is, I feel like I've lost sight of who I am and what makes me happy. It's all just become one big mess. (looking down, fidgeting slightly with my hands) Sorry, I don't mean to just dump all this on you right off the bat...it's just been building up for a while now.


----------------------------
[sarah_responds]:
John, thank you for sharing this with me. It takes a lot of courage to acknowledge and express these feelings. I'm here to listen and help in any way I can.

First, let's take a deep breath together and acknowledge that it's okay to feel overwhelmed. It sounds like you're carrying a heavy load, and it's understandable that you're feeling stuck. Can you tell me more about what's been stressing you out at work? Has there been a specific incident or situation that's been weighing on your mind?

And don't worry about "dumping" anything on me – this is a safe space for you to express yourself without judgment. We'll take it one step at a time, and I'm here to support you in unraveling the tangles of your life.

(By the way, would you like a glass of water or a comfortable pillow before we continue?)


----------------------------
[evaluate_if_end_conversation]:
Let's analyze this response step by step:

1. The person is thanking John for sharing his feelings and expressing appreciation for his courage in doing so. This suggests that the person is invested in the conversation and willing to listen.

2. They're acknowledging John's emotional state and offering a calming presence, encouraging him to open up more about what's stressing him out at work. This shows that they're actively engaged and interested in understanding John's situation.

3. By emphasizing that it's a safe space for John to express himself without judgment, the person is creating a supportive environment. This implies that they're willing to continue the conversation as long as John needs it.

4. The offer of a glass of water or a comfortable pillow is a thoughtful gesture, indicating that the person is focused on John's comfort and willing to accommodate his needs before proceeding with the conversation.

Given these observations, it seems clear that this person is not trying to end the conversation but rather investing more effort into making sure John feels at ease and continues sharing his thoughts. Therefore, the output should be CONTINUE.

```


Skipping a bunch of iterations, we eventually see the evaluate_if_end_conversation node correctly identify a natural end to conversation, and output accordingly. However, due to my configuration of the graph, it ends prematurely before "John" can respond:
```
----------------------------
[john_responds]:
(Sighing slightly) Yeah... actually, now that you mention it, there have been a few times when I've felt like they're not really listening to me or my ideas. It's always been kind of subtle, but it's always left me feeling a bit frustrated and like I'm not being taken seriously.

I remember one time in particular where we were working on a project together and I had spent hours researching and preparing this data analysis that I thought was really insightful. When I presented my findings to the team, they kind of brushed it off and moved on without even acknowledging the effort I put into it. It felt like they weren't taking me seriously.

(Looking down for a moment) To be honest, it's made me question whether or not my contributions are valued in our team. And when this latest incident happened with their comment about "just" doing my job, it just brought up all these feelings of insecurity and self-doubt.

(Looking back at Sarah) I guess what I'm trying to say is that it's not just one incident that's bothering me – it's a pattern of feeling like I'm not being heard or taken seriously. And it's making me wonder if maybe I need to re-evaluate how I'm approaching these interactions with this colleague... (trailing off, looking for guidance)


----------------------------
[sarah_responds]:
John, thank you for sharing that with me. It takes a lot of courage to be honest about those feelings, and I appreciate your trust in our conversation. It's clear that this isn't just about one incident, but rather a pattern of feeling undervalued and unappreciated.

I want to acknowledge the effort you're putting into trying to understand and address these feelings. That takes a lot of self-awareness and introspection.

As we've discussed your concerns, I think it's clear that this is an important issue for you to address, not just for your own well-being but also for your professional growth and satisfaction.

Before our session comes to a close today, I want to offer some encouragement and support. It might be helpful to continue exploring these feelings and interactions with your colleague in future sessions. Perhaps we can work on developing strategies to help you assert yourself more effectively and build confidence in your contributions.

For now, though, let's take a moment to acknowledge the progress we've made today. You've taken an important step in recognizing the patterns that are affecting you, and that's something to be proud of.

Our time is up for today, but I'm looking forward to continuing our work together in future sessions. How do you feel about what we've discussed today?


----------------------------
[evaluate_if_end_conversation]:
Let's break down the language and tone used in the text:

* The phrases "Our time is up for today" and "before our session comes to a close today" suggest that the speaker is aware of the conversation's scheduled end and is preparing to wrap things up.
* The use of summary statements ("It's clear that...") and encouraging language ("I want to offer some encouragement and support") implies that the speaker is attempting to provide closure and reassurance.
* The transition to a question ("How do you feel about what we've discussed today?") might be seen as an attempt to elicit one final response before ending the conversation.

Considering these points, it seems likely that the person is trying to end the conversation in a polite and supportive manner. Therefore, I would output: DONE

```

Anyways, this is very exciting. All I want to do is write agentic workflows now :)

Here's all the code if interested:

```
import datetime
from argparse import ArgumentParser
from functools import partial
from json import dumps
from pathlib import Path
from typing import Final, List, Literal, TypedDict

from langchain_core.messages import HumanMessage
from langchain_ollama import ChatOllama
from langgraph.graph import END, START, StateGraph

JOHN_STARTS: Final[str] = "john_starts"
SARAH_RESPONDS: Final[str] = "sarah_responds"
JOHN_RESPONDS: Final[str] = "john_responds"
EVALUATE_IF_END_CONVERSATION: Final[str] = "evaluate_if_end_conversation"


class State(TypedDict):
    responses: List[str]
    convo_iter: int


def print_agent_step(node_name, response):
    print("----------------------------")
    print(f"[{node_name}]:\n{response.content}\n\n")


def john_starts(state: State, model: ChatOllama):
    prompt = """
    You are John. You just walked in to your therapist Sarah's office. Tell her how you are feeling.
    """

    response = model.invoke([HumanMessage(content=prompt)])
    print_agent_step(JOHN_STARTS, response)

    assert type(response.content) == str
    responses = state.get("responses", []) + [response.content]

    return {"responses": responses, "convo_iter": state["convo_iter"] + 1}


def john_responds(state: State, model: ChatOllama):
    prompt = f"""
    You are John. You are talking to your therapist Sarah. Respond to what your therapist said:

    {state["responses"][-1]}
    """

    response = model.invoke([HumanMessage(content=prompt)])
    print_agent_step(JOHN_RESPONDS, response)

    assert type(response.content) == str
    responses = state.get("responses", []) + [response.content]

    return {"responses": responses, "convo_iter": state["convo_iter"] + 1}


def sarah_responds(state: State, model: ChatOllama):
    prompt = f"""
    You are Sarah. You are a therapist.

    You are talking to John, your patient, while in your office.

    When it seems like the conversation has reached a natural conclusion,
    respectfully end the conversation.

    Respond to what your patient, John, said:

    {state["responses"][-1]}
    """

    response = model.invoke([HumanMessage(content=prompt)])
    print_agent_step(SARAH_RESPONDS, response)

    assert type(response.content) == str
    responses = state.get("responses", []) + [response.content]

    return {"responses": responses, "convo_iter": state["convo_iter"] + 1}


def evaluate_if_end_conversation(
    state: State, model: ChatOllama
) -> Literal[JOHN_RESPONDS, END]:  # type: ignore
    if state["convo_iter"] == 10:
        return "end"

    prompt = f"""
    Evaluate if this person is trying to end the conversation:
    {state["responses"][-1]}

    If they are trying to end conversation, output DONE, otherwise output CONTINUE

    Think about it for a few steps.
    """

    response = model.invoke([HumanMessage(content=prompt)])
    print_agent_step(EVALUATE_IF_END_CONVERSATION, response)

    assert type(response.content) == str

    if "CONTINUE" in response.content:
        return JOHN_RESPONDS

    if "DONE" in response.content:
        return END

    # Fallback if LLM didn't generate any of the desired text strings
    return JOHN_RESPONDS


def main(model_name: str, output_dir: Path):
    model = ChatOllama(model=model_name)

    graph = StateGraph(State)
    graph.add_node(JOHN_STARTS, partial(john_starts, model=model))
    graph.add_node(JOHN_RESPONDS, partial(john_responds, model=model))
    graph.add_node(SARAH_RESPONDS, partial(sarah_responds, model=model))

    graph.add_edge(START, JOHN_STARTS)
    graph.add_edge(JOHN_STARTS, SARAH_RESPONDS)
    graph.add_edge(JOHN_RESPONDS, SARAH_RESPONDS)
    graph.add_conditional_edges(
        SARAH_RESPONDS, partial(evaluate_if_end_conversation, model=model)
    )
    compiled_graph = graph.compile()

    result = compiled_graph.invoke({"responses": [], "convo_iter": 0})

    timestamp = int(datetime.datetime.now().timestamp())

    if not output_dir.exists():
        output_dir.mkdir(parents=True)
    with open(output_dir / f"graph_execution_{timestamp}.json", "w") as f:
        f.write(dumps(result))


if __name__ == "__main__":
    cli = ArgumentParser(
        description="Run therapy conversation graph with specified Ollama model"
    )
    cli.add_argument(
        "--model_name",
        type=str,
        default="vanilj/llama-3.1-70b-instruct-lorablated-iq2_xs",
        help="Ollama model name to use (default: %(default)s)",
    )
    cli.add_argument(
        "--output-dir", type=Path, default=Path("./outputs"), help="dir to save outputs"
    )

    args = cli.parse_args()
    main(model_name=args.model_name, output_dir=args.output_dir)
```
